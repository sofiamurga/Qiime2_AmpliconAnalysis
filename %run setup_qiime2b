# Change to the materials directory
# This is still necessary as other parts of your notebook depend on this.
%cd materials

# --- Installation and Setup ---

# Install Miniconda - adapting the script's logic
# Download the installer
!wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /tmp/miniconda.sh

# Run the installer in silent mode, specifying the installation path
# We'll install it in /usr/local/miniforge3/ as seen in similar setups [1]
!bash /tmp/miniconda.sh -b -p /usr/local/miniforge3

# Clean up the installer
!rm /tmp/miniconda.sh

# Initialize Conda - adapting the script's logic
# This sets up the necessary environment variables for Conda
!/usr/local/miniforge3/bin/conda init bash

# Update PATH to include conda and other binaries - IMPORTANT for subsequent steps
# This is the crucial part that needs to be done in the same shell session
# or by explicitly calling the binaries.
# We can add the miniconda bin to the PATH for the current notebook session
import os
os.environ['PATH'] = '/usr/local/miniforge3/bin:' + os.environ['PATH']

# Verify conda is available
!conda --version

# Create and activate the QIIME 2 environment - adapting the script's logic
# We use 'conda create' and 'conda activate' with the prefix
# This approach is often more reliable in scripting environments
!conda create -y -n qiime2-2024.5 python=3.8

# Activate the environment - this is tricky in notebooks.
# Instead of relying on 'conda activate' to modify the shell state,
# we can directly call commands from the environment's bin directory.
# However, for installing into the environment, 'conda run' is often best.

# Install QIIME 2 and plugins - adapting the script's logic
# Use 'conda run' to execute commands within the specific environment
!conda run -n qiime2-2024.5 pip install qiime2==2024.5

# Install relevant plugins
!conda run -n qiime2-2024.5 pip install qiime2-q2cli==2024.5
!conda run -n qiime2-2024.5 pip install qiime2-q2-feature-classifier==2024.5
!conda run -n qiime2-2024.5 pip install qiime2-q2-dada2==2024.5
!conda run -n qiime2-2024.5 pip install qiime2-q2-phylogeny==2024.5
!conda run -n qiime2-2024.5 pip install qiime2-q2-empress==2024.5
!conda run -n qiime2-2024.5 pip install qiime2-q2-diversity==2024.5
!conda run -n qiime2-2024.5 pip install qiime2-q2-taxa==2024.5

# Install biom-format for exporting
!conda run -n qiime2-2024.5 pip install biom-format

# Download the classifier
!wget https://data.qiime2.org/2024.5/common/ncbi-refseq-genus-515f-806r.qza -O ncbi-refseq-genus-515f-806r.qza

# --- Verification ---

# Verify QIIME 2 installation by running a simple command
# Use 'conda run' to execute qiime from the environment
!conda run -n qiime2-2024.5 qiime info
